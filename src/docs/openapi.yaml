openapi: 3.0.3
info:
  title: ISBE POC – Managements API
  version: 0.1.0
  description: >
    API para la gestión de organizaciones con contratos y anexos.
    Los archivos se almacenan en el sistema de archivos local del servidor y la metadata en PostgreSQL.
    JWT bearer auth requerido; /health es público.
servers:
  - url: http://localhost:3000

tags:
  - name: Health
  - name: Managements

paths:
  /health:
    get:
      security: []
      summary: Health check
      tags: [Health]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }
                  uptime: { type: number, example: 12.34 }
  /metrics:
    get:
      summary: Expose Prometheus metrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
  /api/managements:
    post:
      summary: Crear un management
      description: >
        Crea un nuevo management con contrato y selected_role (JSON con roles activos).
        Los archivos se suben como multipart/form-data y se almacenan en disco local.
        El role_id NO se incluye en la creación, solo el admin puede asignarlo después.
      tags: [Managements]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/ManagementCreate'
      responses:
        '201':
          description: Management creado exitosamente (sin role_id asignado)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Management'
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/managements/{organization_identifier}/documents:
    get:
      summary: Descargar contrato (Usuario)
      description: >
        Permite a usuarios de la organización descargar el archivo del contrato.
      tags: [Managements]
      parameters:
        - in: path
          name: organization_identifier
          required: true
          schema:
            type: string
          description: Identificador único de la organización (PK)
      responses:
        '200':
          description: Archivo del contrato
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          description: Management o archivo no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/managements/{organization_identifier}/contract:
    put:
      summary: Actualizar contrato (Usuario)
      description: >
        Permite a usuarios de la organización actualizar el archivo del contrato.
        Solo se puede modificar el archivo, NO el role_id ni selected_role.
      tags: [Managements]
      parameters:
        - in: path
          name: organization_identifier
          required: true
          schema:
            type: string
          description: Identificador único de la organización (PK)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/ManagementUpdateContract'
      responses:
        '200':
          description: Contrato actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Management'
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Management no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/managements/{organization_identifier}/role:
    put:
      summary: Asignar/cambiar rol (Solo Admin)
      description: >
        Permite al administrador asignar o cambiar el rol de un management.
        Al asignar un rol, se aplican las políticas asociadas.
        Solo accesible para administradores.
      tags: [Managements]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: organization_identifier
          required: true
          schema:
            type: string
          description: Identificador único de la organización (PK)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManagementUpdateRole'
      responses:
        '200':
          description: Rol asignado/actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Management'
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Management no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/managements/organization/{organization_identifier}:
    get:
      summary: Obtener un management por organization_identifier
      description: Obtiene un management específico por su identificador de organización
      tags: [Managements]
      parameters:
        - in: path
          name: organization_identifier
          required: true
          schema:
            type: string
          description: Identificador único de la organización
      responses:
        '200':
          description: Management encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Management'
        '404':
          description: Management no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      summary: Eliminar un management por organization_identifier
      description: Elimina un management específico por su identificador de organización
      tags: [Managements]
      parameters:
        - in: path
          name: organization_identifier
          required: true
          schema:
            type: string
          description: Identificador único de la organización
      responses:
        '200':
          description: Management eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  deleted:
                    $ref: '#/components/schemas/Management'
        '404':
          description: Management no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/managements/admin/all:
    get:
      summary: Obtener todos los managements (Admin)
      description: Retorna todos los managements sin paginación (solo para administradores)
      tags: [Managements]
      responses:
        '200':
          description: Lista de todos los managements
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Management'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/managements/{id}:
    get:
      summary: Obtener un management por ID
      tags: [Managements]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Management encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Management'
        '404':
          description: Management no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    Unauthorized:
      description: No autorizado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Acceso denegado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    DocumentMetadata:
      type: object
      description: Metadata del documento almacenado en disco local
      properties:
        url:
          type: string
          format: uri
          example: "/uploads/contracts/ORG-2024-001_contract_abc123.pdf"
          description: URL relativa del archivo en el servidor (ruta local)
        filename:
          type: string
          example: "contrato_principal.pdf"
          description: Nombre original del archivo
        size:
          type: integer
          example: 1048576
          description: Tamaño del archivo en bytes
        mimeType:
          type: string
          example: "application/pdf"
          description: Tipo MIME del archivo
      required:
        - url
        - filename
        - size
        - mimeType

    SelectedRole:
      type: object
      description: >
        JSON con los roles activos. Se usa para determinar automáticamente el role_id:
        - Solo principal=true -> basic
        - principal=true + proveedor=true -> developer
        - principal=true + operator_exec=true -> op_exec
        - principal=true + auditor=true -> auditor
        - principal=true + operator_cons=true -> op_cons
      properties:
        principal:
          type: boolean
          example: true
          description: Rol principal (siempre debe ser true)
        auditor:
          type: boolean
          example: false
          description: Rol auditor (anexo)
        proveedor:
          type: boolean
          example: false
          description: Rol proveedor (anexo)
        operator_exec:
          type: boolean
          example: false
          description: Rol operator ejecutor (anexo)
        operator_cons:
          type: boolean
          example: false
          description: Rol operator consultor (anexo)
      required:
        - principal
        - auditor
        - proveedor
        - operator_exec
        - operator_cons

    Role:
      type: object
      description: Información completa del rol asignado
      properties:
        id:
          type: integer
          example: 1
        type:
          type: string
          enum: [basic, developer, op_exec, auditor, op_cons]
          example: developer
        policies:
          type: array
          items:
            type: object
          example: [{"action": ["*"], "domain": "ISBE", "function": "*", "type": "organization"}]
        created_at:
          type: string
          format: date-time
        modified_at:
          type: string
          format: date-time

    Management:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 42
        organization_identifier:
          type: string
          example: "ORG-2024-001"
          description: Identificador único de la organización (PK - solo hay uno por compañía)
        contract:
          $ref: '#/components/schemas/DocumentMetadata'
        selected_role:
          $ref: '#/components/schemas/SelectedRole'
        role_id:
          type: integer
          nullable: true
          example: 1
          description: ID del rol asociado (se asigna automáticamente si selected_role coincide con un patrón simple)
        role:
          allOf:
            - $ref: '#/components/schemas/Role'
          nullable: true
          description: Información completa del rol asociado (foreign key)
        created_at:
          type: string
          format: date-time
        modified_at:
          type: string
          format: date-time

    ManagementCreate:
      type: object
      required:
        - organization_identifier
        - contract
        - selected_role
      properties:
        organization_identifier:
          type: string
          example: "ORG-2024-001"
          description: Identificador único de la organización (PK)
        contract:
          type: string
          format: binary
          description: Archivo del contrato (PDF, DOC, etc.) - REQUERIDO
        selected_role:
          type: string
          example: '{"principal":true,"developer":true,"op_exec":false}'
          description: JSON string con roles activos - REQUERIDO
      description: >
        Schema para crear un management. El role_id se asigna automáticamente si selected_role
        coincide con un patrón simple (principal + 1 rol adicional).

    ManagementUpdateContract:
      type: object
      required:
        - contract
      properties:
        contract:
          type: string
          format: binary
          description: Nuevo archivo del contrato
      description: >
        Schema para actualizar el contrato (usuarios).

    ManagementUpdateRole:
      type: object
      required:
        - role_type
      properties:
        role_type:
          type: string
          enum: [basic, developer, op_exec, auditor, op_cons]
          example: developer
          description: Tipo de rol a asignar (basic, developer, op_exec, auditor, op_cons)
      description: >
        Schema para asignar/cambiar rol (solo admin).
        Se envía el tipo de rol y automáticamente se busca y asigna el role_id correspondiente.
        Al asignar un rol, se aplican automáticamente las políticas asociadas.

    Error:
      type: object
      properties:
        error:
          type: string
          example: "Algo salió mal"
        code:
          type: string
          example: "VALIDATION_ERROR"
          description: Código de error (opcional)


name: 1) EKS AWS - Build and push image to ECR
description: Build the Docker image for the application and push it to Amazon ECR, so it can be deployed to the EKS cluster in othrer workflows.

on:
  release:
    types: [published]
  workflow_call: # Allow this workflow to be called by other workflows
    inputs:
      version_tag:
        required: true
        type: string
      branch:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
  workflow_dispatch: # Allow manual triggering with optional input
    inputs:
      version_tag:
        description: 'Image tag to build and push. If not provided, "latest" will be used'
        required: false
        type: string

env:
  GIT_BRANCH: "${{ github.event_name == 'workflow_call' && inputs.branch || inputs.branch || github.ref_name  }}"
  IMAGE_TAG: "${{ github.event_name == 'workflow_call' && inputs.branch || inputs.version_tag || github.event.inputs.version_tag || github.event_name == 'release' &&  github.ref_name || 'latest' }}"
  
permissions:
  contents: read

jobs:
  build:
    name: Build and push image to ECR
    if: ${{ ! startsWith(github.event.head_commit.message, '[NOTBUILD]') && ! startsWith(github.event.head_commit.message, '[AUTO]') }}
    runs-on: ubuntu-latest
    # TODO: change to main or develop, or add other branches
    environment: "${{ github.ref_name == 'main' && 'main' || github.ref_name == 'develop' && 'develop' || 'develop'  }}"

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ env.GIT_BRANCH }}

    - name: Check variables and secrets
      run: |
        echo "ğŸ”‘ BUILD value -> ${{ vars.BUILD }}"
        if [[ -z "${{ vars.BUILD }}" || "${{ vars.BUILD }}" != "true" ]]; then
          echo "âš ï¸ BUILD disabled, please set BUILD=true on Github in variables"
          echo "â­ï¸ Skipping build step."
          exit 0
        fi
        if [[ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]]; then
          echo "ğŸ›‘ AWS_ACCESS_KEY_ID is not set in secrets"
          exit 1
        fi
        if [[ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]]; then
          echo "ğŸ›‘ AWS_SECRET_ACCESS_KEY is not set in secrets"
          exit 1
        fi
        if [[ -z "${{ vars.AWS_REGION }}" ]]; then
          echo "ğŸ›‘ AWS_REGION is not set in variables"
          exit 1
        fi
        if [[ -z "${{ vars.APP_NAME }}" ]]; then
          echo "ğŸ›‘ APP_NAME is not set in variables"
          exit 1
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build image and push to ECR
      id: build-image
      env:
       ECR_REPOSITORY: ${{ vars.APP_NAME }}
       ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        # Construir un contenedor Docker y subirlo a ECR para que pueda ser desplegado en EKS
        echo "ğŸš§ Building and pushing Docker image to ECR..."
        echo "ğŸ—ï¸ event_type: ${{ github.event_name }} | ref_type: ${{ github.ref_type }} | ref_name: ${{ github.ref_name  }}"
        echo "ğŸ—ï¸ Environment: ${{ vars.ENVIRONMENT }}"
        echo "ğŸš€ Build desde rama o tag: ${{ env.GIT_BRANCH }}"
        echo "ğŸ“¦ App name: ${{ vars.APP_NAME }}"
        echo "ğŸ·ï¸ Image tag: ${{ env.IMAGE_TAG }}"
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }} .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}
        echo "  ğŸ‘‰ğŸ» âœ… Imagen Docker Creada y subida a ECR: $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}"
